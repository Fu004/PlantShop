<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trang Ng∆∞·ªùi B√°n - Shop C√¢y C·∫£nh</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/button.css">

    <style>
        #productModal, #editProductModal {
            display: none;
        }
    </style>
    <style>
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .product-card p {
            margin: 5px 0;
            font-size: 15px;
        }
        .product-card img {
            max-height: 150px;
            object-fit: cover;
            border-radius: 5px;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px 25px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            margin-top: 0;
            font-size: 24px;
            margin-bottom: 20px;
            color: #2d572c;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-content button[type="submit"] {
            width: 100%;
            background-color: #4caf50;
            color: white;
            padding: 10px;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-content button[type="submit"]:hover {
            background-color: #3e8e41;
        }

        .delete-btn {
            width: 100%;
            background-color: crimson;
            color: white;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-btn:hover {
            background-color: darkred;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 22px;
            color: #666;
            cursor: pointer;
        }

        .message {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            text-align: center;
        }
    </style>
</head>
<body>
<header>
    <div class="header-flex">
        <span class="shop-title">Seller</span>
        <img src="/images/leaf.png" alt="leaf logo" class="logo-img" />
        <div class="nav-user" th:if="${user != null}">
            <span class="user-id" th:text="${user.UserName}">T√™n ng∆∞·ªùi d√πng</span>
            <form class="formlogout" action="/logout" method="post">
                <button type="submit" class="logout-btn">ƒêƒÉng xu·∫•t</button>
            </form>
        </div>
    </div>
</header>

<nav class="nav">
    <a href="/seller">Trang Ch·ªß Ng∆∞·ªùi B√°n</a>
    <a href="/seller/orders">ƒê∆°n H√†ng</a>
    <a href="/seller/products">S·∫£n Ph·∫©m</a>
</nav>

<div class="container">
    <div class="input-submit">
        <button class="submit-btn" onclick="document.getElementById('productModal').style.display='flex'" id="addbtn"></button>
        <label for="addbtn">Th√™m s·∫£n ph·∫©m</label>
    </div>

    <h2 class="section-title">üì¶ S·∫£n ph·∫©m c·ªßa b·∫°n</h2>
    <div class="products" id="productsList"></div>
</div>

<div id="editProductModal" class="modal-overlay" onclick="closeEditModalOnOutside(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h2>
        <form id="editProductForm" onsubmit="submitEditProductForm(event)">

        <input type="hidden" name="productID" id="editProductID">
            <input type="text" name="productName" id="editProductName" placeholder="T√™n s·∫£n ph·∫©m" required>
            <input type="text" name="productDetails" id="editProductDetails" placeholder="M√¥ t·∫£ s·∫£n ph·∫©m" required>
            <input type="hidden" name="productImage" id="editProductImage">
            <input type="number" name="productPrice" id="editProductPrice" placeholder="Gi√° s·∫£n ph·∫©m" required>
            <input type="number" name="productAmount" id="editProductAmount" placeholder="S·ªë l∆∞·ª£ng" required>
            <input type="number" name="categoryID" id="editCategoryID" placeholder="ID danh m·ª•c" required>
            <button type="submit">L∆∞u</button>
        </form>
        <button id="deleteProductBtn" class="delete-btn">X√≥a s·∫£n ph·∫©m</button>
        <div class="message" id="editMessageProduct"></div>
    </div>
</div>

<div id="productModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Th√™m s·∫£n ph·∫©m m·ªõi</h2>
        <form id="addProductForm" enctype="multipart/form-data">
            <input type="text" name="productName" id="productName" placeholder="T√™n s·∫£n ph·∫©m" required>
            <input type="text" name="productDetails" id="productDetails" placeholder="M√¥ t·∫£ s·∫£n ph·∫©m" required>
            <input type="file" name="productImage" id="productImage" required>
            <input type="number" name="productPrice" id="productPrice" placeholder="Gi√° s·∫£n ph·∫©m" required>
            <input type="number" name="productAmount" id="productAmount" placeholder="S·ªë l∆∞·ª£ng" required>
            <input type="number" name="categoryID" id="categoryID" placeholder="ID danh m·ª•c" required>
            <button type="submit">Th√™m s·∫£n ph·∫©m</button>
        </form>
        <div class="message" id="messageProduct"></div>
    </div>
</div>

<footer>
    ¬© 2025 Shop C√¢y C·∫£nh - Seller Panel. ƒê√£ ƒëƒÉng k√Ω b·∫£n quy·ªÅn.
</footer>

<script>
    const addProductForm = document.getElementById('addProductForm');
    const messageProduct = document.getElementById('messageProduct');

    addProductForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(addProductForm);
        try {
            const res = await fetch('/api/auth/addProduct', {
                method: 'POST',
                body: formData
            });
            const text = await res.text();
            messageProduct.textContent = text;
            if (res.ok) {
                messageProduct.style.color = 'green';
                addProductForm.reset();
                setTimeout(() => {
                    messageProduct.textContent = "";
                    closeModal();
                    loadProducts();
                }, 1500);
            } else {
                messageProduct.style.color = 'red';
            }
        } catch (err) {
            console.error(err);
            messageProduct.textContent = "L·ªói khi th√™m s·∫£n ph·∫©m!";
            messageProduct.style.color = 'red';
        }
    });

    function closeModal() {
        document.getElementById('productModal').style.display = 'none';
    }

    function closeEditModal() {
        document.getElementById('editProductModal').style.display = 'none';
    }

    window.addEventListener('click', function (event) {
        if (event.target === document.getElementById('productModal')) closeModal();
        if (event.target === document.getElementById('editProductModal')) closeEditModal();
    });

    async function loadProducts() {
        try {
            const res = await fetch('/api/auth/getProducts', { method: 'POST' });
            const products = await res.json();
            const listContainer = document.getElementById('productsList');
            listContainer.innerHTML = '';
            if (products.length === 0) {
                listContainer.innerHTML = '<p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</p>';
            }
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
    ${product.ProductImage ? `<img src="${product.ProductImage}" alt="·∫¢nh s·∫£n ph·∫©m">` : ''}
    <h3>${product.ProductName}</h3>
    <p><strong>Gi√°:</strong> <span style="color:red;font-weight: bold;"> ${Number(product.ProductPrice).toLocaleString('vi-VN')} VNƒê</p>
    <p><strong>S·ªë l∆∞·ª£ng:</strong> ${product.ProductAmount}</p>
    <p><strong>M√¥ t·∫£:</strong> ${product.ProductDetails}</p>
`;
                card.onclick = () => openEditModal(product);
                listContainer.appendChild(card);
            });
        } catch (err) {
            console.error('L·ªói khi t·∫£i s·∫£n ph·∫©m:', err);
        }
    }

    function openEditModal(product) {
        document.getElementById('editProductID').value = product.ProductID;
        document.getElementById('editProductName').value = product.ProductName;
        document.getElementById('editProductDetails').value = product.ProductDetails;
        document.getElementById('editProductPrice').value = product.ProductPrice;
        document.getElementById("editProductImage").value = product.ProductImage || "";
        document.getElementById('editProductAmount').value = product.ProductAmount;
        document.getElementById('editCategoryID').value = product.CategoryID;
        document.getElementById('editMessageProduct').textContent = '';
        document.getElementById('editProductModal').style.display = 'flex';
    }

    async function submitEditProductForm(event) {
        event.preventDefault();

        const form = document.getElementById("editProductForm");
        const formData = new FormData(form);
        const jsonData = {};

        formData.forEach((value, key) => {
            switch (key) {
                case "productID": jsonData["ProductID"] = parseInt(value); break;
                case "productName": jsonData["ProductName"] = value; break;
                case "productDetails": jsonData["ProductDetails"] = value; break;
                case "productImage": jsonData["ProductImage"] = value; break;
                case "productPrice": jsonData["ProductPrice"] = parseFloat(value); break;
                case "productAmount": jsonData["ProductAmount"] = parseInt(value); break;
                case "categoryID": jsonData["CategoryID"] = parseInt(value); break;
            }
        });

        console.log("D·ªØ li·ªáu g·ª≠i ƒëi:", jsonData); // ‚ûï debug

        try {
            const response = await fetch("/api/auth/updateProduct", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(jsonData)
            });

            const result = await response.text();
            alert(result);

            if (response.ok) {
                closeEditModal();
                loadProducts();
            }
        } catch (error) {
            console.error("L·ªói khi ch·ªânh s·ª≠a s·∫£n ph·∫©m:", error);
            alert("ƒê√£ x·∫£y ra l·ªói khi ch·ªânh s·ª≠a s·∫£n ph·∫©m.");
        }
    }

    document.getElementById('deleteProductBtn').addEventListener('click', async function () {
        const productID = document.getElementById('editProductID').value;
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;

        try {
            const res = await fetch(`/api/auth/deleteProduct/${productID}`, { method: 'DELETE' });
            const text = await res.text();
            const msg = document.getElementById('editMessageProduct');
            msg.textContent = text;

            if (res.ok) {
                msg.style.color = 'green';
                setTimeout(() => {
                    closeEditModal();
                    loadProducts();
                }, 1000);
            } else {
                msg.style.color = 'red';
            }
        } catch (err) {
            console.error(err);
            const msg = document.getElementById('editMessageProduct');
            msg.textContent = 'L·ªói khi x√≥a s·∫£n ph·∫©m!';
            msg.style.color = 'red';
        }
    });


    window.addEventListener('DOMContentLoaded', loadProducts);
</script>
</body>
</html>