<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trang Ch·ªß - Shop C√¢y C·∫£nh</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <div class="header-flex">
        <span class="shop-title">Little</span>
        <img src="/images/leaf.png" alt="leaf logo" class="logo-img" />
        <form class="search-form" onsubmit="handleSearch(event)">
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm"/>
            <button type="submit" aria-label="T√¨m ki·∫øm">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <circle cx="9" cy="9" r="7" stroke="#fff" stroke-width="2"/>
                    <line x1="14.2" y1="14.2" x2="18" y2="18" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </form>
    </div>
</header>

<nav class="nav">
    <a href="/">Trang Ch·ªß</a>
    <a href="/invoice">H√≥a ƒê∆°n</a>
    <a href="/cart">Gi·ªè H√†ng</a>
    <a href="/contact">Li√™n H·ªá</a>
    <div class="nav-user" th:if="${user != null}">
        <span class="user-id" th:text="${user.UserName}">T√™n ng∆∞·ªùi d√πng</span>
        <form class="formlogout" action="/logout" method="post">
            <button type="submit" class="logout-btn">ƒêƒÉng xu·∫•t</button>
        </form>
    </div>
</nav>

<div th:unless="${user != null}">
    <a href="/login" class="login-btn">ƒêƒÉng nh·∫≠p</a>
</div>

<h2 class="section-title">üå± C√¢y N·ªïi B·∫≠t üå±</h2>
<div class="products" id="productsList"></div>

<!-- Modal overlay -->
<div id="productModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="" alt="·∫¢nh s·∫£n ph·∫©m">
        <h3 id="modalName"></h3>
        <p id="modalPrice"></p>
        <p id="modalAmount"></p>
        <p id="modalCategory"></p>
        <p id="modalDetails"></p>
        <label>S·ªë l∆∞·ª£ng mua:
            <input type="number" id="buyQuantity" min="1" value="1" />
        </label>
        <button onclick="addToCart()">Th√™m v√†o gi·ªè h√†ng</button>
    </div>
</div>

<div style="height: 1200px"></div>
<footer>
    ¬© 2025 Shop C√¢y C·∫£nh. ƒê√£ ƒëƒÉng k√Ω b·∫£n quy·ªÅn.
</footer>

<script>
    let allProducts = [];

    async function loadProducts() {
        try {
            const res = await fetch('/api/auth/getallProducts', { method: 'POST' });
            if (!res.ok) throw new Error("Kh√¥ng th·ªÉ l·∫•y danh s√°ch s·∫£n ph·∫©m");
            allProducts = await res.json();
            renderProducts(allProducts);
        } catch (err) {
            console.error('L·ªói khi t·∫£i s·∫£n ph·∫©m:', err);
        }
    }

    function renderProducts(products) {
        const listContainer = document.getElementById('productsList');
        listContainer.innerHTML = '';
        if (products.length === 0) {
            listContainer.innerHTML = '<p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</p>';
            return;
        }

        products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                ${product.ProductImage ? `<img src="${product.ProductImage}" alt="H√¨nh ·∫£nh s·∫£n ph·∫©m">` : ''}
                <h3>${product.ProductName}</h3>
                <p><strong>Gi√°:</strong> ${Number(product.ProductPrice).toLocaleString('vi-VN')} VNƒê</p>
                <p><strong>S·ªë l∆∞·ª£ng :</strong> ${product.ProductAmount ?? 'Kh√¥ng r√µ'}</p>
                <p><strong>Lo·∫°i:</strong> ${product.CategoryID ?? 'Ch∆∞a ph√¢n lo·∫°i'}</p>
                <p><strong>M√¥ T·∫£: </strong>${product.ProductDetails ?? ''}</p>
            `;
            card.addEventListener('click', () => showProductModal(product));
            listContainer.appendChild(card);
        });
    }

    function handleSearch(event) {
        event.preventDefault();
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allProducts.filter(p =>
            p.ProductName.toLowerCase().includes(keyword) ||
            (p.ProductDetails && p.ProductDetails.toLowerCase().includes(keyword))
        );
        renderProducts(filtered);
    }

    let selectedProduct = null;

    function showProductModal(product) {
        selectedProduct = product;
        document.getElementById('modalImage').src = product.ProductImage || '';
        document.getElementById('modalName').innerText = product.ProductName;
        document.getElementById('modalPrice').innerText = `Gi√°: ${Number(product.ProductPrice).toLocaleString('vi-VN')} VNƒê`;
        document.getElementById('modalAmount').innerText = `C√≤n l·∫°i: ${product.ProductAmount ?? 'Kh√¥ng r√µ'}`;
        document.getElementById('modalCategory').innerText = `Lo·∫°i: ${product.CategoryID ?? 'Ch∆∞a ph√¢n lo·∫°i'}`;
        document.getElementById('modalDetails').innerText = product.ProductDetails ?? '';
        document.getElementById('buyQuantity').value = 1;
        document.getElementById('productModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('productModal').style.display = 'none';
        selectedProduct = null;
    }

    function addToCart() {
        const quantity = parseInt(document.getElementById('buyQuantity').value);
        if (!selectedProduct || quantity <= 0) return;

        const formBody = new URLSearchParams({
            productId: selectedProduct.ProductID,
            quantity: quantity,
            price: selectedProduct.ProductPrice // th√™m d√≤ng n√†y
        });

        fetch("/api/auth/addToCart", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: formBody
        })
            .then(res => {
                if (res.status === 401) {
                    alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi th√™m v√†o gi·ªè h√†ng.');
                    return;
                }
                return res.text();
            })
            .then(msg => {
                if (msg) {
                    console.log(msg);
                    alert(msg);
                    closeModal();
                }
            })
            .catch(err => {
                console.error('L·ªói khi th√™m v√†o gi·ªè:', err);
                alert('ƒê√£ c√≥ l·ªói x·∫£y ra.');
            });
    }

    window.addEventListener('click', function (e) {
        const modal = document.getElementById('productModal');
        if (e.target === modal) closeModal();
    });

    window.addEventListener('DOMContentLoaded', loadProducts);
</script>

</body>
</html>
